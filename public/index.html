<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="theme-color" content="#0a0a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>DudeDude ‚Äî Random Video & Text Chat for Guys ü¶¶</title>
  <meta name="description" content="Meet new guys instantly. Random video and text chat. Free, anonymous, global.">
  <link rel="icon" href="/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#07071a;color:#fff;font-family:'Nunito',sans-serif;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
    button{cursor:pointer;border:none;transition:all .2s;font-family:'Nunito',sans-serif}
    button:active{transform:scale(.96)}
    input:focus{outline:none;border-color:rgba(168,85,247,.5)!important}
    ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}

    /* Screens */
    .screen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
    .screen::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 20%,rgba(168,85,247,.08) 0%,transparent 50%),radial-gradient(circle at 70% 80%,rgba(255,107,107,.06) 0%,transparent 50%);pointer-events:none}
    .hidden{display:none!important}

    /* Logo */
    .logo-main{width:min(280px,70vw);height:auto;filter:drop-shadow(0 4px 30px rgba(168,85,247,.4)) drop-shadow(0 0 60px rgba(255,107,107,.15));animation:logoFloat 4s ease-in-out infinite}
    .logo-lobby{width:min(220px,55vw);height:auto;filter:drop-shadow(0 2px 20px rgba(168,85,247,.3))}
    .logo-xs{height:30px;width:auto;filter:drop-shadow(0 1px 8px rgba(168,85,247,.3))}
    .logo-spin{width:50px;height:auto;filter:drop-shadow(0 2px 12px rgba(255,107,107,.3));animation:bounce 1s ease infinite}

    /* Gradient text */
    .g-text{background:linear-gradient(135deg,#FF6B6B,#C084FC,#60A5FA,#34D399);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gShift 5s ease infinite}
    .muted{color:#6B7280}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#34D399;margin-right:6px;animation:pulse 2s ease infinite;box-shadow:0 0 10px rgba(52,211,153,.5)}
    .dot-sm{width:6px;height:6px;margin-right:5px}

    /* Cards */
    .card{background:rgba(15,15,35,.8);border:1px solid rgba(255,255,255,.06);border-radius:24px;padding:32px 24px;max-width:400px;width:100%;text-align:center;animation:fadeUp .6s ease;backdrop-filter:blur(40px);box-shadow:0 8px 40px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.03)}

    /* Buttons */
    .btn-glow{width:100%;padding:15px 24px;border-radius:16px;background:linear-gradient(135deg,#FF6B6B 0%,#C084FC 50%,#818CF8 100%);color:#fff;font-size:16px;font-weight:700;font-family:'Fredoka',sans-serif;box-shadow:0 4px 25px rgba(192,132,252,.4),0 0 60px rgba(255,107,107,.15);letter-spacing:.3px;position:relative;overflow:hidden}
    .btn-glow::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 40%,rgba(255,255,255,.1) 50%,transparent 60%);animation:shimmer 3s infinite}
    .btn-next-big{width:100%;padding:12px;border-radius:14px;background:linear-gradient(135deg,#FF6B6B,#C084FC);color:#fff;font-size:14px;font-weight:700;font-family:'Fredoka',sans-serif;margin-top:6px;box-shadow:0 4px 15px rgba(192,132,252,.3)}
    .inp{width:100%;padding:13px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:#fff;font-size:15px;font-family:'Nunito',sans-serif;transition:all .2s}
    .inp::placeholder{color:#4B5563}

    /* Badge */
    .badge{display:inline-flex;align-items:center;background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.12);border-radius:24px;padding:6px 16px}
    .badge span{color:#34D399;font-weight:600;font-size:13px}

    /* Camera Preview */
    .cam-preview{width:100%;border-radius:16px;overflow:hidden;background:#111;aspect-ratio:16/9;position:relative;border:1px solid rgba(255,255,255,.06);box-shadow:0 4px 20px rgba(0,0,0,.3)}
    .cam-preview video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    .cam-preview .ph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg,#0f0f23,#1a1035)}
    .cam-label{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);padding:4px 12px;border-radius:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);font-size:11px;color:#94A3B8;font-weight:600}

    /* Features */
    .features{display:flex;justify-content:center;gap:28px;margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,.04)}
    .feature{display:flex;flex-direction:column;align-items:center;gap:5px;font-size:11px;color:#6B7280;font-weight:600}
    .feature-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04)}

    /* Chat */
    .chat-wrap{height:100dvh;display:flex;flex-direction:column;background:#07071a}
    .c-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(15,15,35,.9);border-bottom:1px solid rgba(255,255,255,.04);flex-shrink:0;backdrop-filter:blur(20px)}
    .c-video{position:relative;width:100%;background:#000;flex-shrink:0;aspect-ratio:4/3;max-height:42dvh}
    .c-self{position:absolute;bottom:10px;right:10px;width:90px;height:120px;border-radius:14px;border:2px solid rgba(192,132,252,.5);background:#111;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.5)}
    .c-modebar{display:flex;gap:4px;padding:8px 14px;background:rgba(15,15,35,.9);flex-shrink:0}
    .c-modebtn{flex:1;padding:9px 0;border-radius:12px;background:transparent;color:#6B7280;font-size:12px;font-weight:700;border:1px solid transparent;transition:all .2s}
    .c-modebtn.on{background:rgba(192,132,252,.08);color:#C084FC;border-color:rgba(192,132,252,.15)}
    .c-msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:6px}
    .c-inputbar{display:flex;gap:8px;padding:10px 14px;background:rgba(15,15,35,.9);border-top:1px solid rgba(255,255,255,.04);flex-shrink:0}
    .c-sendbtn{padding:12px 20px;border-radius:14px;background:linear-gradient(135deg,#FF6B6B,#C084FC);color:#fff;font-size:13px;font-weight:700;font-family:'Fredoka',sans-serif;box-shadow:0 2px 12px rgba(192,132,252,.3)}

    .msg-sys{text-align:center;font-size:12px;color:#6B7280;padding:6px 14px;background:rgba(255,255,255,.02);border-radius:14px}
    .msg-warn{color:#FBBF24!important;background:rgba(251,191,36,.04)!important}
    .msg-bub{max-width:78%;padding:10px 14px;border-radius:18px;font-size:13px;line-height:1.5;animation:fadeUp .25s ease}
    .msg-you{align-self:flex-end;background:linear-gradient(135deg,#FF6B6B,#C084FC);border-bottom-right-radius:4px;box-shadow:0 2px 10px rgba(192,132,252,.2)}
    .msg-them{align-self:flex-start;background:rgba(255,255,255,.05);border-bottom-left-radius:4px}
    .msg-from{font-size:10px;font-weight:700;opacity:.5;margin-bottom:2px}
    .retry-btn{display:inline-block;padding:7px 18px;border-radius:10px;background:rgba(192,132,252,.15);color:#C084FC;font-size:12px;font-weight:700;cursor:pointer;border:none}
    .conn-badge{position:absolute;top:10px;left:10px;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;background:rgba(0,0,0,.7);backdrop-filter:blur(10px)}
    .cb-ok{color:#34D399}.cb-wait{color:#FBBF24}.cb-fail{color:#EF4444}

    /* Warning box */
    .warn-box{display:flex;align-items:flex-start;gap:10px;background:rgba(251,191,36,.04);border:1px solid rgba(251,191,36,.1);border-radius:14px;padding:12px 14px;text-align:left}
    .warn-box p{margin:0;font-size:12px;color:#FBBF24;line-height:1.5}

    @keyframes gShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  </style>
</head>
<body>

<!-- ====== AGE GATE ====== -->
<div id="s-age" class="screen">
  <div class="card" style="padding:40px 24px">
    <img src="/logo.png" class="logo-main" alt="DudeDude">
    <p style="color:#9CA3AF;font-size:15px;margin:20px 0 24px;line-height:1.6">Meet new guys instantly.<br><span class="g-text" style="font-weight:700">Random video & text chat.</span></p>
    <div class="warn-box" style="margin-bottom:24px">
      <span style="font-size:18px;flex-shrink:0">‚ö†Ô∏è</span>
      <p>You must be <b>18 or older</b> to enter. By continuing you agree to our Terms of Service.</p>
    </div>
    <button class="btn-glow" onclick="enterApp()">I'm 18+ ‚Äî Enter üî•</button>
    <p style="color:#4B5563;font-size:11px;margin-top:14px">By clicking you confirm you are 18+</p>
  </div>
</div>

<!-- ====== LOBBY ====== -->
<div id="s-lobby" class="screen hidden">
  <div class="card" style="padding:28px 22px">
    <img src="/logo.png" class="logo-lobby" alt="DudeDude">
    <div style="margin-top:14px"><div class="badge"><span class="dot dot-sm"></span><span id="lobby-count">0 dudes online</span></div></div>

    <!-- Camera Preview ‚Äî proper 16:9, centered, rounded -->
    <div class="cam-preview" style="margin-top:18px">
      <video id="previewVid" autoplay playsinline muted></video>
      <div class="ph" id="previewPH">
        <span style="font-size:32px">üì∑</span>
        <p style="color:#6B7280;font-size:12px;margin-top:6px" id="camStatusText">Requesting camera...</p>
      </div>
      <div class="cam-label" id="camLabel">Setting up camera...</div>
    </div>

    <div style="width:100%;margin-top:18px;text-align:left">
      <label style="display:block;color:#6B7280;font-size:11px;margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Nickname <span style="opacity:.5">(optional)</span></label>
      <input type="text" id="inp-name" class="inp" placeholder="Enter a name or stay anonymous..." maxlength="20">
    </div>

    <button class="btn-glow" style="margin-top:20px" onclick="startSearch()">Start Matching üöÄ</button>

    <div class="features">
      <div class="feature"><div class="feature-icon">üé≠</div>Anonymous</div>
      <div class="feature"><div class="feature-icon">‚ö°</div>Instant</div>
      <div class="feature"><div class="feature-icon">üåç</div>Global</div>
    </div>
  </div>
</div>

<!-- ====== SEARCHING ====== -->
<div id="s-search" class="screen hidden">
  <div style="text-align:center">
    <div style="width:90px;height:90px;border-radius:50%;border:3px solid transparent;border-top-color:#FF6B6B;border-right-color:#C084FC;animation:spin 1s linear infinite;margin:0 auto 24px;display:flex;align-items:center;justify-content:center">
      <img src="/logo.png" class="logo-spin" alt="">
    </div>
    <h2 style="font-size:18px;font-family:'Fredoka',sans-serif"><span class="g-text" id="search-text">Looking for a dude...</span></h2>
    <p class="muted" style="font-size:13px;margin-top:8px">Hang tight ‚ú®</p>
    <button style="margin-top:24px;padding:9px 24px;border-radius:12px;background:rgba(239,68,68,.08);color:#EF4444;font-size:12px;font-weight:700;border:1px solid rgba(239,68,68,.1)" onclick="doStop()">‚úï Cancel</button>
  </div>
</div>

<!-- ====== CHAT ====== -->
<div id="s-chat" class="chat-wrap hidden">
  <div class="c-header">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="/logo.png" class="logo-xs" alt="">
      <div>
        <span style="font-size:13px;font-weight:700;font-family:'Fredoka',sans-serif" class="g-text">DudeDude</span>
        <div style="display:flex;align-items:center;margin-top:1px"><span class="dot dot-sm" style="width:5px;height:5px"></span><span style="font-size:10px;color:#6B7280" id="chat-online">0</span></div>
      </div>
    </div>
    <div style="display:flex;gap:6px">
      <button style="padding:7px 14px;border-radius:10px;background:rgba(239,68,68,.06);color:#EF4444;font-size:12px;font-weight:700;border:1px solid rgba(239,68,68,.08)" onclick="doStop()">‚úï Stop</button>
      <button style="padding:7px 18px;border-radius:10px;background:linear-gradient(135deg,#FF6B6B,#C084FC);color:#fff;font-size:12px;font-weight:700;font-family:'Fredoka',sans-serif;box-shadow:0 2px 10px rgba(192,132,252,.25)" onclick="doNext()">Next ‚è≠Ô∏è</button>
    </div>
  </div>
  <div class="c-video" id="videoArea">
    <video id="remoteVid" autoplay playsinline style="width:100%;height:100%;object-fit:cover;background:#000"></video>
    <div id="remotePH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg,#0a0a1a,#1a1035)">
      <span style="font-size:48px">üé≠</span>
      <p style="color:#6B7280;font-size:12px;margin-top:8px" id="remoteLbl">Connecting video...</p>
    </div>
    <span class="conn-badge cb-wait" id="connStatus">‚è≥ Connecting...</span>
    <div style="position:absolute;bottom:10px;left:10px;display:flex;align-items:center;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700"><span class="dot dot-sm"></span><span id="partnerLbl">Partner</span></div>
    <div class="c-self">
      <video id="localVid" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
      <div id="selfPH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg,#0f0f23,#1a1035)"><span style="font-size:22px">üì∑</span><p style="color:#6B7280;font-size:9px;margin-top:2px">You</p></div>
    </div>
  </div>
  <div class="c-modebar">
    <button class="c-modebtn on" id="modeVid" onclick="setMode('video')">üìπ Video</button>
    <button class="c-modebtn" id="modeTxt" onclick="setMode('text')">üí¨ Text Only</button>
  </div>
  <div class="c-msgs" id="msgs"></div>
  <div class="c-inputbar">
    <input type="text" id="chatInp" class="inp" style="flex:1" placeholder="Type a message..." maxlength="500" onkeydown="if(event.key==='Enter')sendMsg()">
    <button class="c-sendbtn" onclick="sendMsg()">Send</button>
  </div>
  <div style="text-align:center;padding:6px 0 max(8px,env(safe-area-inset-bottom));background:rgba(15,15,35,.9)">
    <button style="background:transparent;border:none;color:#4B5563;font-size:11px" onclick="doReport()">üö© Report</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket=io({transports:["websocket","polling"],reconnection:true,reconnectionAttempts:Infinity,reconnectionDelay:1000,reconnectionDelayMax:5000});
let localStream=null,hasCamera=false,hasMic=false,pc=null,remoteStream=null,partnerName="",myName="Anonymous",curMode="video",isInitiator=false,iceRetryCount=0,iceFailTimer=null,isMatched=false;
const MAX_ICE_RETRIES=4;
const ICE_CONFIG={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"},{urls:"turns:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:standard.relay.metered.ca:80",username:"e8dd65b92f003a9b7f1cb174",credential:"3zOJqoYb2gXIi/Ak"},{urls:"turn:standard.relay.metered.ca:443",username:"e8dd65b92f003a9b7f1cb174",credential:"3zOJqoYb2gXIi/Ak"},{urls:"turns:standard.relay.metered.ca:443?transport=tcp",username:"e8dd65b92f003a9b7f1cb174",credential:"3zOJqoYb2gXIi/Ak"}],iceCandidatePoolSize:10,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"};

function show(id){['s-age','s-lobby','s-search','s-chat'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden')}
async function enterApp(){show('s-lobby');await acquireMedia()}
function startSearch(){myName=document.getElementById('inp-name').value.trim()||"Anonymous";isMatched=false;show('s-search');searchAnim();socket.emit('startSearch',{name:myName})}
function doNext(){closePeer();isMatched=false;iceRetryCount=0;show('s-search');searchAnim();socket.emit('next')}
function doStop(){closePeer();isMatched=false;iceRetryCount=0;socket.emit('stop');show('s-lobby');showLocalPreview()}
function showPartnerLeft(){closePeer();isMatched=false;addMsg('warn','‚ö° '+esc(partnerName)+' left the chat.');const b=document.getElementById('msgs'),el=document.createElement('div');el.className='msg-sys';el.innerHTML='<button class="btn-next-big" onclick="doNext()">Find Next Dude ‚è≠Ô∏è</button>';b.appendChild(el);b.scrollTop=b.scrollHeight;document.getElementById('chatInp').disabled=true;document.getElementById('chatInp').placeholder='Partner left...'}
function setMode(m){curMode=m;document.getElementById('modeVid').classList.toggle('on',m==='video');document.getElementById('modeTxt').classList.toggle('on',m==='text');document.getElementById('videoArea').style.display=m==='video'?'':'none'}

async function acquireMedia(){
  if(localStream&&localStream.active){showLocalPreview();return}
  const st=document.getElementById('camStatusText'),lb=document.getElementById('camLabel');
  st.textContent='Requesting camera & mic...';lb.textContent='Setting up...';
  try{localStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:640,max:1280},height:{ideal:480,max:720},frameRate:{ideal:24,max:30}},audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true,sampleRate:44100}});hasCamera=true;hasMic=true;st.textContent='‚úÖ Camera & mic ready';lb.textContent='‚úÖ Ready';showLocalPreview();return}catch(e){}
  try{localStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:640},height:{ideal:480}},audio:false});hasCamera=true;hasMic=false;st.textContent='üì∑ Camera ready (no mic)';lb.textContent='üì∑ No mic';showLocalPreview();return}catch(e){}
  try{localStream=await navigator.mediaDevices.getUserMedia({video:false,audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});hasCamera=false;hasMic=true;st.textContent='üé§ Mic only';lb.textContent='üé§ Mic only';return}catch(e){}
  hasCamera=false;hasMic=false;localStream=null;st.textContent='üí¨ Text only mode';lb.textContent='üí¨ Text only'
}
function showLocalPreview(){if(localStream&&hasCamera){document.getElementById('previewVid').srcObject=localStream;document.getElementById('previewPH').style.display='none';document.getElementById('localVid').srcObject=localStream;document.getElementById('selfPH').style.display='none'}}

let searchTmr;
function searchAnim(){const t=["Looking for a dude","Scanning the globe","Finding your match","Almost there"];let i=0,d=0;clearInterval(searchTmr);searchTmr=setInterval(()=>{d=(d+1)%4;if(!d)i=(i+1)%t.length;document.getElementById('search-text').textContent=t[i]+".".repeat(d)},400)}

function addMsg(type,html,name){const b=document.getElementById('msgs'),el=document.createElement('div');if(type==='sys'){el.className='msg-sys';el.innerHTML=html}else if(type==='warn'){el.className='msg-sys msg-warn';el.innerHTML=html}else{el.className='msg-bub '+(type==='you'?'msg-you':'msg-them');el.innerHTML='<div class="msg-from">'+(type==='you'?'You':esc(name))+'</div>'+esc(html)}b.appendChild(el);b.scrollTop=b.scrollHeight}
function clearMsgs(){document.getElementById('msgs').innerHTML=''}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function sendMsg(){const inp=document.getElementById('chatInp'),txt=inp.value.trim();if(!txt||!isMatched)return;addMsg('you',txt);socket.emit('chatMessage',{text:txt});inp.value='';inp.focus()}
function doReport(){socket.emit('report',{reason:'user_report'});alert('User reported. Thanks! ü¶¶')}

function setCS(t,c){const el=document.getElementById('connStatus');el.textContent=t;el.className='conn-badge '+c}
async function makePeer(init){closePeer();isInitiator=init;iceRetryCount=0;clearTimeout(iceFailTimer);setCS('‚è≥ Connecting...','cb-wait');pc=new RTCPeerConnection(ICE_CONFIG);if(localStream){localStream.getTracks().forEach(t=>pc.addTrack(t,localStream))}else{pc.addTransceiver('video',{direction:'recvonly'});pc.addTransceiver('audio',{direction:'recvonly'})}remoteStream=new MediaStream();document.getElementById('remoteVid').srcObject=remoteStream;pc.ontrack=(e)=>{remoteStream.addTrack(e.track);if(e.track.kind==='video'){document.getElementById('remotePH').style.display='none';setCS('üü¢ Connected','cb-ok')}e.track.onunmute=()=>{if(e.track.kind==='video')document.getElementById('remotePH').style.display='none';forcePlay(document.getElementById('remoteVid'))}};pc.onicecandidate=(e)=>{if(e.candidate)socket.emit('signal',{type:'candidate',candidate:e.candidate})};pc.oniceconnectionstatechange=()=>{if(!pc)return;const s=pc.iceConnectionState;switch(s){case'checking':setCS('‚è≥ Connecting...','cb-wait');break;case'connected':case'completed':setCS('üü¢ Connected','cb-ok');iceRetryCount=0;clearTimeout(iceFailTimer);forcePlay(document.getElementById('remoteVid'));break;case'disconnected':setCS('‚ö° Reconnecting...','cb-wait');clearTimeout(iceFailTimer);iceFailTimer=setTimeout(()=>{if(pc&&pc.iceConnectionState==='disconnected')handleIceF()},6000);break;case'failed':clearTimeout(iceFailTimer);handleIceF();break}};if(init){try{const o=await pc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});await pc.setLocalDescription(o);socket.emit('signal',{type:'offer',sdp:pc.localDescription})}catch(e){addMsg('warn','‚ö†Ô∏è Could not start video. Text chat works!')}}}
function forcePlay(v){if(!v)return;const p=v.play();if(p)p.catch(()=>{document.getElementById('videoArea').addEventListener('click',function h(){v.play();document.getElementById('videoArea').removeEventListener('click',h)},{once:true})})}
async function handleIceF(){if(!pc||!isMatched)return;if(iceRetryCount<MAX_ICE_RETRIES){iceRetryCount++;setCS('üîÑ Retry '+iceRetryCount+'/'+MAX_ICE_RETRIES,'cb-wait');addMsg('warn','‚ö° Video hiccup. Retrying ('+iceRetryCount+'/'+MAX_ICE_RETRIES+')...');try{if(isInitiator){const o=await pc.createOffer({iceRestart:true});await pc.setLocalDescription(o);socket.emit('signal',{type:'offer',sdp:pc.localDescription})}else{socket.emit('iceRestart')}}catch(e){}}else{setCS('‚ùå Video failed','cb-fail');addMsg('warn','‚ö†Ô∏è Video couldn\'t connect. Text chat still works! üí¨');const b=document.getElementById('msgs'),el=document.createElement('div');el.className='msg-sys';el.innerHTML='<button class="retry-btn" onclick="retryV()">üîÑ Try Video Again</button>';b.appendChild(el);b.scrollTop=b.scrollHeight}}
async function retryV(){if(!pc)return;iceRetryCount=0;setCS('üîÑ Retrying...','cb-wait');addMsg('sys','üîÑ Retrying video...');try{if(isInitiator){const o=await pc.createOffer({iceRestart:true});await pc.setLocalDescription(o);socket.emit('signal',{type:'offer',sdp:pc.localDescription})}else{socket.emit('iceRestart')}}catch(e){addMsg('warn','‚ö†Ô∏è Retry failed.');setCS('‚ùå Failed','cb-fail')}}
function closePeer(){clearTimeout(iceFailTimer);if(pc){pc.close();pc=null}remoteStream=null;document.getElementById('remoteVid').srcObject=null;document.getElementById('remotePH').style.display='flex';document.getElementById('remoteLbl').textContent='Connecting video...';setCS('','')}

socket.on('onlineCount',n=>{document.getElementById('lobby-count').textContent=n+' dudes online';document.getElementById('chat-online').textContent=n+' online'});
socket.on('matched',async(d)=>{clearInterval(searchTmr);partnerName=d.partnerName;isMatched=true;iceRetryCount=0;show('s-chat');setMode('video');clearMsgs();document.getElementById('partnerLbl').textContent=partnerName;document.getElementById('remoteLbl').textContent='Connecting video...';document.getElementById('chatInp').disabled=false;document.getElementById('chatInp').placeholder='Type a message...';if(localStream&&hasCamera){document.getElementById('localVid').srcObject=localStream;document.getElementById('selfPH').style.display='none'}addMsg('sys','üéâ Connected with <b>'+esc(partnerName)+'</b>! Say hi üëã');if(!hasCamera&&!hasMic)addMsg('sys','üí¨ Text-only mode');else if(!hasCamera)addMsg('sys','üé§ Audio only');else if(!hasMic)addMsg('sys','üì∑ Video only ‚Äî no mic');await makePeer(d.initiator)});
socket.on('signal',async(d)=>{if(!pc)return;try{if(d.type==='offer'){if(pc.signalingState==='have-local-offer'&&!isInitiator)await pc.setLocalDescription({type:'rollback'});await pc.setRemoteDescription(new RTCSessionDescription(d.sdp));const a=await pc.createAnswer();await pc.setLocalDescription(a);socket.emit('signal',{type:'answer',sdp:pc.localDescription})}else if(d.type==='answer'){if(pc.signalingState==='have-local-offer')await pc.setRemoteDescription(new RTCSessionDescription(d.sdp))}else if(d.type==='candidate'){if(pc.remoteDescription)try{await pc.addIceCandidate(new RTCIceCandidate(d.candidate))}catch(e){}}}catch(e){console.error('Signal err:',e)}});
socket.on('iceRestart',async()=>{if(!pc||!isInitiator)return;try{const o=await pc.createOffer({iceRestart:true});await pc.setLocalDescription(o);socket.emit('signal',{type:'offer',sdp:pc.localDescription})}catch(e){}});
socket.on('chatMessage',d=>{if(isMatched)addMsg('them',d.text,d.from)});
socket.on('partnerDisconnected',()=>{if(!isMatched)return;showPartnerLeft()});
socket.on('disconnect',()=>{if(isMatched)addMsg('warn','üîå Connection lost. Reconnecting...')});
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'){if(localStream&&hasCamera){const l=document.getElementById('localVid');if(l.srcObject!==localStream)l.srcObject=localStream;l.play().catch(()=>{})}const r=document.getElementById('remoteVid');if(r.srcObject)r.play().catch(()=>{})}});
</script>
</body>
</html>
