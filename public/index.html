<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="theme-color" content="#0a0a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>DudeDude.app ‚Äî Random Video & Text Chat for Guys ü¶¶</title>
  <meta name="description" content="Meet new guys instantly. Random video and text chat. Free, anonymous, global.">
  <link rel="icon" href="/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0a0a1a;color:#fff;font-family:'Nunito',sans-serif;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
    button{cursor:pointer;border:none;transition:all .15s;font-family:'Nunito',sans-serif}
    button:active{transform:scale(.96)}
    input:focus{outline:none;border-color:rgba(168,85,247,.5)!important}
    ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}

    .screen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px;background:linear-gradient(160deg,#0a0a1a 0%,#1a1035 50%,#0d0d20 100%)}
    .card{background:rgba(20,20,40,.9);border:1px solid rgba(255,255,255,.06);border-radius:22px;padding:30px 24px;max-width:380px;width:100%;text-align:center;animation:fadeUp .5s ease;backdrop-filter:blur(20px)}
    .hidden{display:none!important}

    .logo{height:130px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(168,85,247,.3))}
    .logo-sm{height:90px;object-fit:contain;filter:drop-shadow(0 2px 12px rgba(168,85,247,.2))}
    .logo-xs{height:34px;object-fit:contain}
    .logo-spin{height:64px;object-fit:contain;animation:bounce 1s ease infinite;filter:drop-shadow(0 2px 12px rgba(255,107,107,.3))}
    .gradient-text{background:linear-gradient(135deg,#FF6B6B,#A855F7,#4ECDC4,#FFE66D);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradShift 4s ease infinite}
    .muted{color:#94A3B8}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#34D399;margin-right:6px;animation:pulse 2s ease infinite;box-shadow:0 0 8px #34D399}
    .dot-sm{width:6px;height:6px;margin-right:4px}
    .btn-main{width:100%;padding:14px 20px;border-radius:14px;background:linear-gradient(135deg,#FF6B6B,#A855F7);color:#fff;font-size:16px;font-weight:700;font-family:'Fredoka',sans-serif;box-shadow:0 4px 24px rgba(255,107,107,.3)}
    .btn-next-big{width:100%;padding:12px;border-radius:12px;background:linear-gradient(135deg,#FF6B6B,#A855F7);color:#fff;font-size:14px;font-weight:700;font-family:'Fredoka',sans-serif;margin-top:6px}
    .inp{width:100%;padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.04);color:#fff;font-size:15px;font-family:'Nunito',sans-serif}
    .badge{display:inline-flex;align-items:center;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.15);border-radius:20px;padding:5px 14px;gap:2px}
    .badge span{color:#34D399;font-weight:600;font-size:13px}

    .chat-wrap{height:100dvh;display:flex;flex-direction:column;background:#0a0a1a}
    .c-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#111125;border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0}
    .c-video{position:relative;width:100%;background:#000;flex-shrink:0;aspect-ratio:4/3;max-height:40dvh}
    .c-self{position:absolute;bottom:8px;right:8px;width:85px;height:115px;border-radius:12px;border:2px solid #A855F7;background:#111125;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.5)}
    .c-modebar{display:flex;gap:4px;padding:6px 12px;background:#111125;flex-shrink:0}
    .c-modebtn{flex:1;padding:8px 0;border-radius:10px;background:transparent;color:#94A3B8;font-size:12px;font-weight:600;border:1px solid transparent}
    .c-modebtn.on{background:rgba(168,85,247,.1);color:#fff;border-color:rgba(255,255,255,.06)}
    .c-msgs{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .c-inputbar{display:flex;gap:6px;padding:10px 12px;background:#111125;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0}
    .c-sendbtn{padding:10px 18px;border-radius:12px;background:linear-gradient(135deg,#FF6B6B,#A855F7);color:#fff;font-size:13px;font-weight:700;font-family:'Fredoka',sans-serif}
    .msg-sys{text-align:center;font-size:12px;color:#94A3B8;padding:6px 12px;background:rgba(255,255,255,.02);border-radius:12px}
    .msg-warn{color:#FFE66D!important;background:rgba(255,230,109,.05)!important}
    .msg-bub{max-width:78%;padding:8px 14px;border-radius:16px;font-size:13px;line-height:1.5;animation:fadeUp .25s ease}
    .msg-you{align-self:flex-end;background:linear-gradient(135deg,#FF6B6B,#A855F7);border-bottom-right-radius:4px}
    .msg-them{align-self:flex-start;background:rgba(255,255,255,.06);border-bottom-left-radius:4px}
    .msg-from{font-size:10px;font-weight:700;opacity:.55;margin-bottom:1px}
    .retry-btn{display:inline-block;padding:6px 16px;border-radius:8px;background:rgba(168,85,247,.2);color:#A855F7;font-size:12px;font-weight:700;cursor:pointer;border:none}
    .cam-status{position:absolute;top:8px;left:8px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;background:rgba(0,0,0,.7)}
    .cam-ok{color:#34D399}.cam-fail{color:#EF4444}.cam-wait{color:#FFE66D}

    @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<!-- AGE GATE -->
<div id="s-age" class="screen">
  <div class="card">
    <img src="/logo.png" class="logo" alt="DudeDude">
    <p class="muted" style="font-size:14px;margin:14px 0 22px;line-height:1.6">Random video & text chat for guys.<br>Meet someone new instantly. ü¶¶</p>
    <div style="display:flex;align-items:center;gap:10px;background:rgba(255,230,109,.07);border:1px solid rgba(255,230,109,.15);border-radius:14px;padding:11px 14px;margin-bottom:22px;text-align:left">
      <span style="font-size:18px">‚ö†Ô∏è</span>
      <p style="margin:0;font-size:12px;color:#FFE66D">You must be <b>18 or older</b> to enter. By continuing you agree to our Terms of Service.</p>
    </div>
    <button class="btn-main" onclick="enterApp()">I'm 18+ ‚Äî Let me in üî•</button>
    <p class="muted" style="font-size:11px;margin-top:14px">By clicking you confirm you are 18 years or older</p>
  </div>
</div>

<!-- LOBBY -->
<div id="s-lobby" class="screen hidden">
  <div class="card">
    <img src="/logo.png" class="logo-sm" alt="DudeDude">
    <div class="badge" style="margin-top:12px"><span class="dot dot-sm"></span><span id="lobby-count">0 dudes online</span></div>
    <div id="camPreview" style="margin-top:16px;border-radius:14px;overflow:hidden;background:#000;aspect-ratio:4/3;max-height:180px;position:relative">
      <video id="previewVid" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
      <div id="previewPH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#111125">
        <span style="font-size:28px">üì∑</span>
        <p class="muted" style="font-size:11px;margin-top:4px" id="camStatusText">Requesting camera...</p>
      </div>
    </div>
    <div style="width:100%;margin-top:16px;text-align:left">
      <label style="display:block;color:#94A3B8;font-size:12px;margin-bottom:6px;font-weight:600">NICKNAME <span style="opacity:.5">(optional)</span></label>
      <input type="text" id="inp-name" class="inp" placeholder="Enter a name or stay anonymous..." maxlength="20">
    </div>
    <button class="btn-main" style="margin-top:18px" onclick="startSearch()">Start Matching üöÄ</button>
    <div style="display:flex;justify-content:center;gap:24px;margin-top:18px;padding-top:14px;border-top:1px solid rgba(255,255,255,.05)">
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;color:#94A3B8"><span style="font-size:18px">üé≠</span>Anonymous</div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;color:#94A3B8"><span style="font-size:18px">‚ö°</span>Instant</div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;color:#94A3B8"><span style="font-size:18px">üåç</span>Global</div>
    </div>
  </div>
</div>

<!-- SEARCHING -->
<div id="s-search" class="screen hidden">
  <div style="text-align:center">
    <div style="width:96px;height:96px;border-radius:50%;border:3px solid transparent;border-top-color:#FF6B6B;border-right-color:#A855F7;animation:spin 1s linear infinite;margin:0 auto 22px;display:flex;align-items:center;justify-content:center">
      <img src="/logo.png" class="logo-spin" alt="">
    </div>
    <h2 style="font-size:18px;font-family:'Fredoka',sans-serif"><span class="gradient-text" id="search-text">Looking for a dude...</span></h2>
    <p class="muted" style="font-size:13px;margin-top:8px">Hang tight ‚ú®</p>
    <button style="margin-top:20px;padding:8px 20px;border-radius:10px;background:rgba(239,68,68,.1);color:#EF4444;font-size:12px;font-weight:600" onclick="doStop()">‚úï Cancel</button>
  </div>
</div>

<!-- CHAT -->
<div id="s-chat" class="chat-wrap hidden">
  <div class="c-header">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="/logo.png" class="logo-xs" alt="">
      <div>
        <span style="font-size:14px;font-weight:700;font-family:'Fredoka',sans-serif" class="gradient-text">dudedude</span>
        <div style="display:flex;align-items:center;margin-top:1px"><span class="dot dot-sm"></span><span style="font-size:10px;color:#94A3B8" id="chat-online">0</span></div>
      </div>
    </div>
    <div style="display:flex;gap:6px">
      <button style="padding:7px 14px;border-radius:10px;background:rgba(239,68,68,.1);color:#EF4444;font-size:12px;font-weight:600" onclick="doStop()">‚úï Stop</button>
      <button style="padding:7px 16px;border-radius:10px;background:linear-gradient(135deg,#FF6B6B,#A855F7);color:#fff;font-size:12px;font-weight:700;font-family:'Fredoka',sans-serif" onclick="doNext()">Next ‚è≠Ô∏è</button>
    </div>
  </div>
  <div class="c-video" id="videoArea">
    <video id="remoteVid" autoplay playsinline style="width:100%;height:100%;object-fit:cover;background:#000"></video>
    <div id="remotePH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000">
      <span style="font-size:48px">üé≠</span>
      <p class="muted" style="font-size:12px;margin-top:8px" id="remoteLbl">Connecting video...</p>
    </div>
    <span class="cam-status cam-wait" id="connStatus">‚è≥ Connecting...</span>
    <div style="position:absolute;bottom:8px;left:8px;display:flex;align-items:center;background:rgba(0,0,0,.7);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700"><span class="dot dot-sm"></span><span id="partnerLbl">Partner</span></div>
    <div class="c-self">
      <video id="localVid" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1)"></video>
      <div id="selfPH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#111125"><span style="font-size:24px">üì∑</span><p class="muted" style="font-size:9px;margin-top:2px">You</p></div>
    </div>
  </div>
  <div class="c-modebar">
    <button class="c-modebtn on" id="modeVid" onclick="setMode('video')">üìπ Video</button>
    <button class="c-modebtn" id="modeTxt" onclick="setMode('text')">üí¨ Text Only</button>
  </div>
  <div class="c-msgs" id="msgs"></div>
  <div class="c-inputbar">
    <input type="text" id="chatInp" class="inp" style="flex:1" placeholder="Type a message..." maxlength="500" onkeydown="if(event.key==='Enter')sendMsg()">
    <button class="c-sendbtn" onclick="sendMsg()">Send</button>
  </div>
  <div style="text-align:center;padding:6px 0 max(8px,env(safe-area-inset-bottom));background:#111125">
    <button style="background:transparent;border:none;color:#64748B;font-size:11px" onclick="doReport()">üö© Report</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ============================================================
// STATE
// ============================================================
const socket = io({
  transports: ["websocket", "polling"],
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
});

let localStream = null;
let hasCamera = false;
let hasMic = false;
let pc = null;
let remoteStream = null;
let partnerName = "";
let myName = "Anonymous";
let curMode = "video";
let isInitiator = false;
let iceRetryCount = 0;
let iceFailTimer = null;
let isMatched = false;  // Track if we're currently in a match
const MAX_ICE_RETRIES = 4;

const ICE_CONFIG = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" },
    { urls: "stun:stun2.l.google.com:19302" },
    { urls: "stun:stun3.l.google.com:19302" },
    { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
    { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
    { urls: "turns:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" },
    { urls: "turn:standard.relay.metered.ca:80", username: "e8dd65b92f003a9b7f1cb174", credential: "3zOJqoYb2gXIi/Ak" },
    { urls: "turn:standard.relay.metered.ca:443", username: "e8dd65b92f003a9b7f1cb174", credential: "3zOJqoYb2gXIi/Ak" },
    { urls: "turns:standard.relay.metered.ca:443?transport=tcp", username: "e8dd65b92f003a9b7f1cb174", credential: "3zOJqoYb2gXIi/Ak" },
  ],
  iceCandidatePoolSize: 10,
  iceTransportPolicy: "all",
  bundlePolicy: "max-bundle",
  rtcpMuxPolicy: "require",
};

// ============================================================
// SCREENS
// ============================================================
function show(id) {
  ['s-age','s-lobby','s-search','s-chat'].forEach(s => document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

async function enterApp() {
  show('s-lobby');
  await acquireMedia();
}

function startSearch() {
  myName = document.getElementById('inp-name').value.trim() || "Anonymous";
  isMatched = false;
  show('s-search');
  searchAnim();
  socket.emit('startSearch', { name: myName });
}

function doNext() {
  closePeer();
  isMatched = false;
  iceRetryCount = 0;
  show('s-search');
  searchAnim();
  socket.emit('next');
}

function doStop() {
  closePeer();
  isMatched = false;
  iceRetryCount = 0;
  socket.emit('stop');
  show('s-lobby');
  showLocalPreview();
}

// Called when partner leaves ‚Äî user can click "Find Next" or "Stop"
function showPartnerLeft() {
  closePeer();
  isMatched = false;
  addMsg('warn', '‚ö° ' + esc(partnerName) + ' left the chat.');

  // Show "Find Next Dude" button IN the chat
  const box = document.getElementById('msgs');
  const el = document.createElement('div');
  el.className = 'msg-sys';
  el.innerHTML = '<button class="btn-next-big" onclick="doNext()">Find Next Dude ‚è≠Ô∏è</button>';
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;

  // Disable input
  document.getElementById('chatInp').disabled = true;
  document.getElementById('chatInp').placeholder = 'Partner left...';
}

function setMode(m) {
  curMode = m;
  document.getElementById('modeVid').classList.toggle('on', m === 'video');
  document.getElementById('modeTxt').classList.toggle('on', m === 'text');
  document.getElementById('videoArea').style.display = m === 'video' ? '' : 'none';
}

// ============================================================
// CAMERA + MIC ‚Äî ACQUIRE ONCE
// ============================================================
async function acquireMedia() {
  if (localStream && localStream.active) { showLocalPreview(); return; }
  const st = document.getElementById('camStatusText');
  st.textContent = 'Requesting camera & mic...';

  // Try video + audio
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"user", width:{ideal:640,max:1280}, height:{ideal:480,max:720}, frameRate:{ideal:24,max:30} },
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:44100 },
    });
    hasCamera = true; hasMic = true;
    st.textContent = '‚úÖ Camera & mic ready';
    showLocalPreview(); return;
  } catch(e) { console.log('Full media fail:', e.name); }

  // Video only
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user",width:{ideal:640},height:{ideal:480}}, audio:false });
    hasCamera = true; hasMic = false;
    st.textContent = 'üì∑ Camera ready (no mic)';
    showLocalPreview(); return;
  } catch(e) { console.log('Video fail:', e.name); }

  // Audio only
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:false, audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true} });
    hasCamera = false; hasMic = true;
    st.textContent = 'üé§ Mic ready (no camera)';
    return;
  } catch(e) { console.log('Audio fail:', e.name); }

  // Nothing
  hasCamera = false; hasMic = false; localStream = null;
  st.textContent = 'üí¨ Text only mode';
}

function showLocalPreview() {
  if (localStream && hasCamera) {
    document.getElementById('previewVid').srcObject = localStream;
    document.getElementById('previewPH').style.display = 'none';
    document.getElementById('localVid').srcObject = localStream;
    document.getElementById('selfPH').style.display = 'none';
  }
}

// ============================================================
// SEARCH ANIMATION
// ============================================================
let searchTmr;
function searchAnim() {
  const t = ["Looking for a dude","Scanning the globe","Finding your match","Almost there"];
  let i=0,d=0;
  clearInterval(searchTmr);
  searchTmr = setInterval(() => { d=(d+1)%4; if(!d) i=(i+1)%t.length; document.getElementById('search-text').textContent=t[i]+".".repeat(d); }, 400);
}

// ============================================================
// MESSAGES
// ============================================================
function addMsg(type, html, name) {
  const box = document.getElementById('msgs');
  const el = document.createElement('div');
  if (type==='sys') { el.className='msg-sys'; el.innerHTML=html; }
  else if (type==='warn') { el.className='msg-sys msg-warn'; el.innerHTML=html; }
  else {
    el.className = 'msg-bub '+(type==='you'?'msg-you':'msg-them');
    el.innerHTML = '<div class="msg-from">'+(type==='you'?'You':esc(name))+'</div>'+esc(html);
  }
  box.appendChild(el); box.scrollTop = box.scrollHeight;
}
function clearMsgs() { document.getElementById('msgs').innerHTML=''; }
function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

function sendMsg() {
  const inp = document.getElementById('chatInp');
  const txt = inp.value.trim();
  if (!txt || !isMatched) return;
  addMsg('you', txt);
  socket.emit('chatMessage', { text:txt });
  inp.value = ''; inp.focus();
}

function doReport() {
  socket.emit('report', { reason:'user_report' });
  alert('User reported. Thanks! ü¶¶');
}

// ============================================================
// WEBRTC
// ============================================================
function setConnStatus(text, cls) {
  const el = document.getElementById('connStatus');
  el.textContent = text; el.className = 'cam-status ' + cls;
}

async function makePeer(initiator) {
  closePeer();
  isInitiator = initiator;
  iceRetryCount = 0;
  clearTimeout(iceFailTimer);
  setConnStatus('‚è≥ Connecting...', 'cam-wait');

  pc = new RTCPeerConnection(ICE_CONFIG);

  // Add local tracks
  if (localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  } else {
    pc.addTransceiver('video', { direction:'recvonly' });
    pc.addTransceiver('audio', { direction:'recvonly' });
  }

  // Remote stream
  remoteStream = new MediaStream();
  document.getElementById('remoteVid').srcObject = remoteStream;

  pc.ontrack = (event) => {
    console.log('[TRACK]', event.track.kind, event.track.readyState);
    remoteStream.addTrack(event.track);
    if (event.track.kind === 'video') {
      document.getElementById('remotePH').style.display = 'none';
      setConnStatus('üü¢ Connected', 'cam-ok');
    }
    event.track.onunmute = () => {
      if (event.track.kind === 'video') document.getElementById('remotePH').style.display = 'none';
      forcePlay(document.getElementById('remoteVid'));
    };
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) socket.emit('signal', { type:'candidate', candidate:e.candidate });
  };

  pc.oniceconnectionstatechange = () => {
    if (!pc) return;
    const s = pc.iceConnectionState;
    console.log('[ICE]', s);
    switch(s) {
      case 'checking': setConnStatus('‚è≥ Connecting...','cam-wait'); break;
      case 'connected': case 'completed':
        setConnStatus('üü¢ Connected','cam-ok');
        iceRetryCount = 0; clearTimeout(iceFailTimer);
        forcePlay(document.getElementById('remoteVid'));
        break;
      case 'disconnected':
        setConnStatus('‚ö° Reconnecting...','cam-wait');
        clearTimeout(iceFailTimer);
        iceFailTimer = setTimeout(() => { if(pc && pc.iceConnectionState==='disconnected') handleIceFailure(); }, 6000);
        break;
      case 'failed': clearTimeout(iceFailTimer); handleIceFailure(); break;
    }
  };

  if (initiator) {
    try {
      const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:true });
      await pc.setLocalDescription(offer);
      socket.emit('signal', { type:'offer', sdp:pc.localDescription });
    } catch(e) {
      console.error('Offer error:', e);
      addMsg('warn', '‚ö†Ô∏è Could not start video. Text chat works!');
    }
  }
}

function forcePlay(v) {
  if (!v) return;
  const p = v.play();
  if (p) p.catch(() => {
    document.getElementById('videoArea').addEventListener('click', function h() {
      v.play(); document.getElementById('videoArea').removeEventListener('click', h);
    }, { once:true });
  });
}

async function handleIceFailure() {
  if (!pc || !isMatched) return;
  if (iceRetryCount < MAX_ICE_RETRIES) {
    iceRetryCount++;
    setConnStatus(`üîÑ Retry ${iceRetryCount}/${MAX_ICE_RETRIES}`,'cam-wait');
    addMsg('warn', `‚ö° Video hiccup. Retrying (${iceRetryCount}/${MAX_ICE_RETRIES})...`);
    try {
      if (isInitiator) {
        const offer = await pc.createOffer({ iceRestart:true });
        await pc.setLocalDescription(offer);
        socket.emit('signal', { type:'offer', sdp:pc.localDescription });
      } else { socket.emit('iceRestart'); }
    } catch(e) { console.error('ICE restart err:', e); }
  } else {
    setConnStatus('‚ùå Video failed','cam-fail');
    addMsg('warn', '‚ö†Ô∏è Video couldn\'t connect. Text chat still works! üí¨');
    const box = document.getElementById('msgs');
    const el = document.createElement('div'); el.className='msg-sys';
    el.innerHTML = '<button class="retry-btn" onclick="retryVideo()">üîÑ Try Video Again</button>';
    box.appendChild(el); box.scrollTop = box.scrollHeight;
  }
}

async function retryVideo() {
  if (!pc) return;
  iceRetryCount = 0;
  setConnStatus('üîÑ Retrying...','cam-wait');
  addMsg('sys','üîÑ Retrying video...');
  try {
    if (isInitiator) {
      const offer = await pc.createOffer({ iceRestart:true });
      await pc.setLocalDescription(offer);
      socket.emit('signal', { type:'offer', sdp:pc.localDescription });
    } else { socket.emit('iceRestart'); }
  } catch(e) { addMsg('warn','‚ö†Ô∏è Retry failed. Text chat works!'); setConnStatus('‚ùå Video failed','cam-fail'); }
}

function closePeer() {
  clearTimeout(iceFailTimer);
  if (pc) { pc.close(); pc = null; }
  remoteStream = null;
  document.getElementById('remoteVid').srcObject = null;
  document.getElementById('remotePH').style.display = 'flex';
  document.getElementById('remoteLbl').textContent = 'Connecting video...';
  setConnStatus('','');
}

// ============================================================
// SOCKET EVENTS
// ============================================================
socket.on('onlineCount', n => {
  document.getElementById('lobby-count').textContent = n + ' dudes online';
  document.getElementById('chat-online').textContent = n + ' online';
});

socket.on('matched', async (data) => {
  clearInterval(searchTmr);
  partnerName = data.partnerName;
  isMatched = true;
  iceRetryCount = 0;

  show('s-chat'); setMode('video'); clearMsgs();
  document.getElementById('partnerLbl').textContent = partnerName;
  document.getElementById('remoteLbl').textContent = 'Connecting video...';
  document.getElementById('chatInp').disabled = false;
  document.getElementById('chatInp').placeholder = 'Type a message...';

  if (localStream && hasCamera) {
    document.getElementById('localVid').srcObject = localStream;
    document.getElementById('selfPH').style.display = 'none';
  }

  addMsg('sys', 'üéâ Connected with <b>'+esc(partnerName)+'</b>! Say hi üëã');
  if (!hasCamera && !hasMic) addMsg('sys','üí¨ Text-only mode');
  else if (!hasCamera) addMsg('sys','üé§ Audio only ‚Äî no camera');
  else if (!hasMic) addMsg('sys','üì∑ Video only ‚Äî no mic');

  await makePeer(data.initiator);
});

socket.on('signal', async (data) => {
  if (!pc) return;
  try {
    if (data.type === 'offer') {
      if (pc.signalingState === 'have-local-offer' && !isInitiator) {
        await pc.setLocalDescription({ type:'rollback' });
      }
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.emit('signal', { type:'answer', sdp:pc.localDescription });
    } else if (data.type === 'answer') {
      if (pc.signalingState === 'have-local-offer') {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      }
    } else if (data.type === 'candidate') {
      if (pc.remoteDescription) {
        try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch(e) {}
      }
    }
  } catch(e) { console.error('Signal err:', e); }
});

socket.on('iceRestart', async () => {
  if (!pc || !isInitiator) return;
  try {
    const offer = await pc.createOffer({ iceRestart:true });
    await pc.setLocalDescription(offer);
    socket.emit('signal', { type:'offer', sdp:pc.localDescription });
  } catch(e) {}
});

socket.on('chatMessage', d => { if(isMatched) addMsg('them', d.text, d.from); });

// PARTNER LEFT ‚Äî show message + "Find Next" button. NO auto-skip.
socket.on('partnerDisconnected', () => {
  if (!isMatched) return; // Ignore if we already moved on
  showPartnerLeft();
});

socket.on('disconnect', () => { if(isMatched) addMsg('warn','üîå Connection lost. Reconnecting...'); });
socket.on('connect', () => console.log('Socket connected'));

// Tab visibility
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    if (localStream && hasCamera) {
      const lv = document.getElementById('localVid');
      if (lv.srcObject !== localStream) lv.srcObject = localStream;
      lv.play().catch(()=>{});
    }
    const rv = document.getElementById('remoteVid');
    if (rv.srcObject) rv.play().catch(()=>{});
  }
});
</script>
</body>
</html>
